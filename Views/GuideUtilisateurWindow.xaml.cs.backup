using System;
using System.Collections.Generic;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Media;
using BacklogManager.Domain;
using BacklogManager.Services;

namespace BacklogManager.Views
{
    public partial class GuideUtilisateurWindow : Window
    {
        private readonly AuthenticationService _authService;
        private readonly Role _userRole;
        private Dictionary<string, string> _questionsReponses;

        public GuideUtilisateurWindow(AuthenticationService authService)
        {
            InitializeComponent();
            _authService = authService;
            _userRole = _authService.GetCurrentUserRole();
            
            ChargerQuestionsSelonRole();
        }

        private void ChargerQuestionsSelonRole()
        {
            if (_userRole == null) return;

            TxtRole.Text = string.Format("Guide {0}", _userRole.Nom);
            _questionsReponses = new Dictionary<string, string>();

            switch (_userRole.Type)
            {
                case RoleType.Administrateur:
                    ChargerQuestionsAdministrateur();
                    break;
                case RoleType.ChefDeProjet:
                    ChargerQuestionsChefDeProjet();
                    break;
                case RoleType.Developpeur:
                    ChargerQuestionsDeveloppeur();
                    break;
                case RoleType.BusinessAnalyst:
                    ChargerQuestionsBusinessAnalyst();
                    break;
                default:
                    ChargerQuestionsGenerales();
                    break;
            }

            AfficherQuestions();
        }

        private void ChargerQuestionsAdministrateur()
        {
            _questionsReponses = new Dictionary<string, string>
            {
                { "Comment ajouter un nouvel utilisateur ?", 
                    "Excellente question ! Voici comment proc√©der de mani√®re simple :\n\n" +
                    "1Ô∏è‚É£ Rendez-vous dans l'onglet **Administration** en haut de l'application\n" +
                    "2Ô∏è‚É£ Cliquez sur **Gestion des utilisateurs**\n" +
                    "3Ô∏è‚É£ Appuyez sur le bouton **‚ûï Nouvel utilisateur**\n" +
                    "4Ô∏è‚É£ Remplissez les informations : nom, pr√©nom, email\n" +
                    "5Ô∏è‚É£ Choisissez le r√¥le appropri√© (Dev, Chef de projet, etc.)\n" +
                    "6Ô∏è‚É£ Validez et voil√† ! L'utilisateur peut maintenant se connecter.\n\n" +
                    "üí° *Astuce* : Pensez √† bien choisir le r√¥le d√®s le d√©part, cela d√©finit les permissions !" },
                
                { "Comment g√©rer les projets ?",
                    "Ah, la gestion de projets ! C'est un peu comme diriger un orchestre üéº\n\n" +
                    "**Pour cr√©er un projet :**\n" +
                    "‚Ä¢ Allez dans **Projets & √âquipes**\n" +
                    "‚Ä¢ Cliquez sur **Cr√©er un projet**\n" +
                    "‚Ä¢ D√©finissez le nom, la dur√©e des sprints\n" +
                    "‚Ä¢ Assignez un chef de projet\n" +
                    "‚Ä¢ Ajoutez les d√©veloppeurs √† l'√©quipe\n\n" +
                    "**Pour suivre l'avancement :**\n" +
                    "‚Ä¢ Le **Dashboard** vous donne une vue globale\n" +
                    "‚Ä¢ Le **Kanban** montre les t√¢ches en temps r√©el\n" +
                    "‚Ä¢ Le **Suivi CRA** indique le temps pass√©\n\n" +
                    "üéØ *Mon conseil* : Revoyez r√©guli√®rement les projets pour ajuster les √©quipes si besoin !" },
                
                { "Que faire avec les demandes obsol√®tes ?",
                    "Bonne question ! Les demandes obsol√®tes, c'est comme les vieux papiers : il faut les ranger üì¶\n\n" +
                    "**Pourquoi archiver ?**\n" +
                    "‚Ä¢ Garde la liste des demandes actives propre et lisible\n" +
                    "‚Ä¢ Pr√©serve l'historique sans encombrer\n" +
                    "‚Ä¢ Am√©liore les performances de l'application\n\n" +
                    "**Comment faire ?**\n" +
                    "1. Allez dans **Demandes**\n" +
                    "2. S√©lectionnez la demande obsol√®te\n" +
                    "3. Cliquez sur **Archiver** (seuls les admins peuvent le faire)\n" +
                    "4. La demande dispara√Æt de la vue principale\n\n" +
                    "**Pour retrouver une demande archiv√©e ?**\n" +
                    "Rendez-vous dans **Archives** ! Tout y est conserv√©.\n\n" +
                    "‚ö†Ô∏è *Important* : N'archivez que les demandes vraiment termin√©es ou annul√©es !" },
                
                { "Comment valider les CRA ?",
                    "Ah, les CRA ! Le suivi du temps, c'est essentiel pour mesurer la productivit√© üìä\n\n" +
                    "**Pourquoi valider les CRA ?**\n" +
                    "‚Ä¢ Permet de distinguer le temps pr√©visionnel du temps r√©el\n" +
                    "‚Ä¢ Donne des statistiques pr√©cises\n" +
                    "‚Ä¢ Aide √† mieux estimer les futures t√¢ches\n\n" +
                    "**La proc√©dure est simple :**\n" +
                    "1. Allez dans **CRA Calendrier** ou **Suivi CRA**\n" +
                    "2. Vous voyez des journ√©es en orange ? Elles sont √† valider\n" +
                    "3. Cliquez sur le bouton **orange de validation**\n" +
                    "4. La journ√©e passe en vert ‚úÖ\n\n" +
                    "**Les 3 √©tats :**\n" +
                    "‚Ä¢ üü† Orange clair : pr√©visionnel futur\n" +
                    "‚Ä¢ üü† Orange vif : pass√©, √† valider\n" +
                    "‚Ä¢ üü¢ Vert : valid√©, compte dans les stats\n\n" +
                    "üí° *Conseil d'Einstein* : Validez r√©guli√®rement (chaque fin de semaine par exemple) !" },
                
                { "Comment voir les statistiques globales ?",
                    "Les statistiques, c'est mon dada ! J'adore les chiffres üìà\n\n" +
                    "**Le Dashboard est votre ami :**\n" +
                    "‚Ä¢ Vue d'ensemble avec les KPIs principaux\n" +
                    "‚Ä¢ Nombre de t√¢ches termin√©es, en cours, √† faire\n" +
                    "‚Ä¢ Productivit√© du jour en pourcentage\n" +
                    "‚Ä¢ Charge de travail des d√©veloppeurs\n\n" +
                    "**Le Suivi CRA pour le d√©tail :**\n" +
                    "‚Ä¢ Temps pass√© par d√©veloppeur\n" +
                    "‚Ä¢ S√©paration travail / cong√©s / non-travaill√©\n" +
                    "‚Ä¢ Statistiques par p√©riode (mois, ann√©e)\n" +
                    "‚Ä¢ Export possible vers Excel\n\n" +
                    "**Cliquez sur un dev dans les stats :**\n" +
                    "Une fen√™tre s'ouvre avec toutes ses m√©triques d√©taill√©es !\n\n" +
                    "üî¨ *Ma m√©thode* : Consultez le Dashboard tous les matins, √ßa donne le pouls du projet !" }
            };
        }

            AjouterSection("üìã Gestion des t√¢ches",
                "‚Ä¢ Acc√©dez au Backlog pour voir toutes les t√¢ches\n" +
                "‚Ä¢ Cr√©ez des t√¢ches √† partir des demandes accept√©es\n" +
                "‚Ä¢ Assignez les t√¢ches aux d√©veloppeurs disponibles\n" +
                "‚Ä¢ D√©finissez les priorit√©s et dates limites\n" +
                "‚Ä¢ Utilisez le Kanban pour visualiser l'avancement",
                CreerBoutonAction("Voir le Backlog", "Backlog"));

            AjouterSection("üìÅ Suivi des projets",
                "‚Ä¢ Consultez l'onglet Projets & √âquipes\n" +
                "‚Ä¢ Suivez l'avancement de chaque sprint\n" +
                "‚Ä¢ V√©rifiez la charge de travail des d√©veloppeurs\n" +
                "‚Ä¢ Ajustez les ressources si n√©cessaire");

            AjouterSection("‚è±Ô∏è Validation des CRA",
                "‚Ä¢ Acc√©dez √† Suivi CRA pour consulter les temps saisis\n" +
                "‚Ä¢ V√©rifiez la coh√©rence avec les t√¢ches assign√©es\n" +
                "‚Ä¢ Identifiez les d√©passements ou blocages\n" +
                "‚Ä¢ Communiquez avec l'√©quipe si besoin",
                CreerBoutonAction("Consulter les CRA", "CRA"));

            AjouterSection("üéØ Bonnes pratiques",
                "‚úì Priorisez les demandes selon la valeur m√©tier\n" +
                "‚úì Communiquez r√©guli√®rement avec les d√©veloppeurs\n" +
                "‚úì Anticipez les risques de d√©passement de d√©lais\n" +
                "‚úì Validez les sp√©cifications avant cr√©ation de t√¢ches");
        }

        private void ChargerGuideDeveloppeur()
        {
            AjouterSection("üéØ Vue d'ensemble",
                "En tant que D√©veloppeur, vous r√©alisez les t√¢ches qui vous sont assign√©es et saisissez votre temps de travail quotidien.");

            AjouterSection("üìã Mes t√¢ches",
                "‚Ä¢ Consultez vos t√¢ches dans l'onglet Backlog\n" +
                "‚Ä¢ Utilisez le Kanban pour voir les t√¢ches √Ä faire, En cours, En test\n" +
                "‚Ä¢ Cliquez sur une t√¢che pour voir ses d√©tails\n" +
                "‚Ä¢ Mettez √† jour le statut au fur et √† mesure de l'avancement",
                CreerBoutonAction("Voir mes t√¢ches", "Kanban"));

            AjouterSection("‚è±Ô∏è Saisie CRA (quotidienne)",
                "‚Ä¢ Acc√©dez √† l'onglet Saisir CRA tous les jours\n" +
                "‚Ä¢ S√©lectionnez le jour dans le calendrier\n" +
                "‚Ä¢ Pour chaque t√¢che travaill√©e, saisissez le temps\n" +
                "‚Ä¢ Ajoutez un commentaire d√©crivant ce qui a √©t√© fait\n" +
                "‚Ä¢ Le temps est en jours : 0.5j = 4h, 1j = 8h",
                CreerBoutonAction("Saisir mon CRA", "CRA"));

            AjouterSection("üîÑ Workflow des t√¢ches",
                "1. √Ä faire ‚Üí Commencez la t√¢che, passez-la \"En cours\"\n" +
                "2. En cours ‚Üí D√©veloppement en cours, saisissez votre temps quotidien\n" +
                "3. En test ‚Üí Une fois termin√©, passez en test pour validation\n" +
                "4. Termin√© ‚Üí Le chef valide et cl√¥ture la t√¢che");

            AjouterSection("üí¨ Communication",
                "‚Ä¢ Utilisez les commentaires sur les t√¢ches pour signaler un probl√®me\n" +
                "‚Ä¢ Pr√©venez votre chef si vous √™tes bloqu√©\n" +
                "‚Ä¢ Indiquez si vous estimez d√©passer le temps pr√©vu\n" +
                "‚Ä¢ Mettez √† jour r√©guli√®rement le statut de vos t√¢ches");

            AjouterSection("‚úÖ Bonnes pratiques",
                "‚úì Saisissez votre CRA quotidiennement (ne pas attendre la fin de semaine)\n" +
                "‚úì Soyez pr√©cis dans vos commentaires CRA\n" +
                "‚úì Alertez rapidement en cas de blocage technique\n" +
                "‚úì Consultez le Kanban r√©guli√®rement pour voir vos priorit√©s");
        }

        private void ChargerGuideBusinessAnalyst()
        {
            AjouterSection("üéØ Vue d'ensemble",
                "En tant que Business Analyst, vous collectez les besoins m√©tier, r√©digez les sp√©cifications et facilitez le chiffrage des demandes.");

            AjouterSection("üìù Cr√©ation de demandes",
                "‚Ä¢ Acc√©dez √† l'onglet Demandes\n" +
                "‚Ä¢ Cliquez sur \"Nouvelle demande\" pour cr√©er une demande\n" +
                "‚Ä¢ Renseignez le titre, description et contexte m√©tier\n" +
                "‚Ä¢ D√©finissez la criticit√© selon l'urgence\n" +
                "‚Ä¢ Assignez un projet si applicable",
                CreerBoutonAction("Cr√©er une demande", "Demandes"));

            AjouterSection("üìã Sp√©cifications d√©taill√©es",
                "‚Ä¢ Pour chaque demande, cliquez sur \"D√©tails\"\n" +
                "‚Ä¢ Compl√©tez les sp√©cifications fonctionnelles\n" +
                "‚Ä¢ D√©crivez les b√©n√©fices attendus pour le m√©tier\n" +
                "‚Ä¢ Ajoutez des crit√®res d'acceptation clairs\n" +
                "‚Ä¢ Joignez des maquettes ou documents si n√©cessaire");

            AjouterSection("üíº Suivi des demandes",
                "‚Ä¢ Consultez r√©guli√®rement vos demandes en cours\n" +
                "‚Ä¢ Filtrez par statut pour voir l'avancement\n" +
                "‚Ä¢ R√©pondez aux questions des d√©veloppeurs dans les commentaires\n" +
                "‚Ä¢ Participez au chiffrage avec l'√©quipe technique");

            AjouterSection("ü§ù Collaboration",
                "‚Ä¢ Travaillez avec le Chef de Projet pour prioriser\n" +
                "‚Ä¢ Clarifiez les besoins avec les d√©veloppeurs\n" +
                "‚Ä¢ Validez que les d√©veloppements correspondent aux attentes\n" +
                "‚Ä¢ Participez aux sessions de planning poker si n√©cessaire");

            AjouterSection("‚úÖ Bonnes pratiques",
                "‚úì R√©digez des sp√©cifications claires et sans ambigu√Øt√©\n" +
                "‚úì D√©finissez des crit√®res d'acceptation mesurables\n" +
                "‚úì Priorisez les demandes avec le m√©tier\n" +
                "‚úì Restez disponible pour r√©pondre aux questions techniques");
        }

        private void ChargerGuideGeneral()
        {
            AjouterSection("üéØ Bienvenue sur BacklogManager",
                "BacklogManager est votre outil de gestion de projets et de suivi d'activit√©. Naviguez dans les diff√©rents onglets pour acc√©der aux fonctionnalit√©s.");

            AjouterSection("üìä Dashboard",
                "Votre tableau de bord personnel affiche vos statistiques et t√¢ches en cours.",
                CreerBoutonAction("Voir Dashboard", "Dashboard"));

            AjouterSection("üìã Backlog & Kanban",
                "Consultez et g√©rez les t√¢ches du projet.",
                CreerBoutonAction("Voir Backlog", "Backlog"));

            AjouterSection("üìù Demandes",
                "G√©rez les demandes de d√©veloppement.",
                CreerBoutonAction("Voir Demandes", "Demandes"));
        }

        private void AjouterSection(string titre, string contenu, UIElement actionButton = null)
        {
            // Card container
            var border = new Border
            {
                Background = Brushes.White,
                CornerRadius = new CornerRadius(10),
                Padding = new Thickness(20, 18, 20, 18),
                Margin = new Thickness(0, 0, 0, 15),
                Effect = new System.Windows.Media.Effects.DropShadowEffect
                {
                    BlurRadius = 10,
                    ShadowDepth = 0,
                    Opacity = 0.1,
                    Color = Colors.Gray
                }
            };

            var stackPanel = new StackPanel();

            // Titre
            var txtTitre = new TextBlock
            {
                Text = titre,
                FontSize = 18,
                FontWeight = FontWeights.Bold,
                Foreground = new SolidColorBrush(Color.FromRgb(26, 25, 25)),
                Margin = new Thickness(0, 0, 0, 12)
            };
            stackPanel.Children.Add(txtTitre);

            // Contenu
            var txtContenu = new TextBlock
            {
                Text = contenu,
                FontSize = 14,
                Foreground = new SolidColorBrush(Color.FromRgb(102, 102, 102)),
                TextWrapping = TextWrapping.Wrap,
                LineHeight = 22,
                Margin = new Thickness(0, 0, 0, actionButton != null ? 15 : 0)
            };
            stackPanel.Children.Add(txtContenu);

            // Bouton d'action si fourni
            if (actionButton != null)
            {
                stackPanel.Children.Add(actionButton);
            }

            border.Child = stackPanel;
            ContentPanel.Children.Add(border);
        }

        private Button CreerBoutonAction(string texte, string cible)
        {
            var button = new Button
            {
                Content = string.Format("‚Üí {0}", texte),
                Height = 38,
                Padding = new Thickness(18, 0, 18, 0),
                Background = new SolidColorBrush(Color.FromRgb(0, 145, 90)),
                Foreground = Brushes.White,
                FontSize = 13,
                FontWeight = FontWeights.SemiBold,
                BorderThickness = new Thickness(0),
                Cursor = System.Windows.Input.Cursors.Hand,
                HorizontalAlignment = HorizontalAlignment.Left,
                Tag = cible
            };

            button.Click += BoutonAction_Click;

            // Style avec template
            var style = new Style(typeof(Button));
            var template = new ControlTemplate(typeof(Button));
            
            var borderFactory = new FrameworkElementFactory(typeof(Border));
            borderFactory.SetValue(Border.BackgroundProperty, new TemplateBindingExtension(Button.BackgroundProperty));
            borderFactory.SetValue(Border.CornerRadiusProperty, new CornerRadius(6));
            borderFactory.SetValue(Border.PaddingProperty, new TemplateBindingExtension(Button.PaddingProperty));
            
            var contentFactory = new FrameworkElementFactory(typeof(ContentPresenter));
            contentFactory.SetValue(ContentPresenter.HorizontalAlignmentProperty, HorizontalAlignment.Center);
            contentFactory.SetValue(ContentPresenter.VerticalAlignmentProperty, VerticalAlignment.Center);
            
            borderFactory.AppendChild(contentFactory);
            template.VisualTree = borderFactory;
            
            var hoverTrigger = new Trigger { Property = Button.IsMouseOverProperty, Value = true };
            hoverTrigger.Setters.Add(new Setter(Button.BackgroundProperty, new SolidColorBrush(Color.FromRgb(0, 120, 67))));
            template.Triggers.Add(hoverTrigger);
            
            style.Setters.Add(new Setter(Button.TemplateProperty, template));
            button.Style = style;

            return button;
        }

        private void BoutonAction_Click(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            if (button?.Tag is string cible)
            {
                // Fermer la fen√™tre et indiquer quelle action effectuer
                this.Tag = cible;
                this.DialogResult = true;
                this.Close();
            }
        }
    }
}
